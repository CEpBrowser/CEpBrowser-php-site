<!-- GeNemo Card element
  A wrapper for title and contents.
  Contents should implement GenemoTabCardContentBehavior,
  and can be folded unless disable-folding is set on the card.

  When the local DOM initialization is done, domReady flag will be set.
  When content-dom-ready event occurs and local DOM has been completed,
  populateDOM() will be called to populate local DOM, then content-dom-ready
  will be bubbled to parent elements

-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../give-styles.html">
<link rel="import" href="../../bower_components/shadycss/apply-shim.html">
<link href="//fonts.googleapis.com/css?family=Roboto:500,400italic,700italic,700,400" rel="stylesheet" type="text/css">
<dom-module id="give-card">
  <template>
    <style include="give-shared-styles">
    :host {
      display: inline-block;
      font-family: 'Roboto', Arial, Helvetica, sans-serif;
      margin: 0.6em 0;
      z-index: 0;
      text-align: left;
      position: relative;
      @apply --give-card-mixin;
    }

    /************************** Polymer and Material Design components below *********************/

    /************************** Polymer and Material Design size and others below *********************/
    #hiddenCardHeaderHolder {
      display: none;
    }
    paper-material {
      background: var(--card-background-color);
      @apply --give-card-material-mixin;
    }

    #cardFixedContent {
      @apply --give-card-fixed-content-mixin;
    }

  </style>
    <paper-material elevation="1">
      <template is="dom-if" if="[[!_readiness]]">
        <div id="loadingBlock">
          <paper-spinner id="loadingSpinner" alt="Loading card content"
            active$="[[!_readiness]]">
          </paper-spinner>
        </div>
      </template>
      <div id="cardHeader" class="clearFix cardHeader vertCenterContainer">
        <template is="dom-if" if="[[!disableFolding]]" restamp="true">
          <paper-icon-button icon="[[expandIcon]]" class="leftFloat"
            id="expandButton" on-click="toggleCollapse">
          </paper-icon-button>
        </template>
        <template is="dom-if" if="[[_showOriginalHeader]]">
          <div id="cardHeaderContainer" class="vertCenterElement"></div>
        </template>
        <div id="hiddenCardHeaderHolder">
          <slot id="cardHeaderSlot" name="header"></slot>
        </div>
      </div>
      <slot id="cardBodySlot" name="body"></slot>
      <template is="dom-if" if="[[!disableFolding]]" restamp="true">
        <iron-collapse id="mainCollapse" opened="{{isOpened}}" allowOverflow>
        </iron-collapse>
      </template>
      <template is="dom-if" if="[[disableFolding]]" restamp="true">
        <div id="cardFixedContent" hidden$="[[!disableFolding]]"></div>
      </template>
    </paper-material>
  </template>
  <script>
var GIVe = (function (give) {
  'use strict'

  class GiveCard extends Polymer.Element {
    static get is () {
      return 'give-card'
    }

    static get properties () {
      return {
        isOpened: {
          type: Boolean,
          value: true,
          observer: '_isOpenedChanged'
        },

        expandIcon: {
          type: String,
          value: 'expand-more'
        },

        domReady: { // flag indicating whether local DOM is ready
          type: Boolean,
          value: false,
          readOnly: true
        },

        disableFolding: {
          type: Boolean,
          value: false,
          observer: '_disableFoldingObserver'
        },

        _readiness: {
          type: Boolean,
          value: false
        },

        _showOriginalHeader: {
          type: Boolean,
          value: true
        }
      }
    }

    ready () {
      super.ready()
      this._collapsedHeaderElement = null
      this._boundContentReadyHandler = this._contentReadyHandler.bind(this)
      this._boundSlotChangeHandler = this._slotChangeHandler.bind(this)
      this.$.cardBodySlot.addEventListener(
        'slotchange', this._boundSlotChangeHandler
      )
      this.$.cardHeaderSlot.addEventListener(
        'slotchange', this._boundSlotChangeHandler
      )
      this.addEventListener(
        'content-ready', this._boundContentReadyHandler
      )
    }

    connectedCallback () {
      super.connectedCallback()
      Polymer.RenderStatus.beforeNextRender(this, () => {
        this.populateDOM()
        this._setContentReady(true)
      })
    }

    _slotChangeHandler (event) {
      this.populateDOM()
      this._setContentReady(true)
    }

    _disableFoldingObserver (newValue, oldValue) {
      Polymer.RenderStatus.afterNextRender(this, () => {
        if (newValue) {
          this.shadowRoot.querySelector('#cardFixedContent')
            .appendChild(this.$.cardBodySlot)
        } else {
          this.shadowRoot.querySelector('#mainCollapse')
            .appendChild(this.$.cardBodySlot)
        }
      })
    }

    _toggleCollapseHeader (flag) {
      // the top node with cardBodySlot should have a property named
      //    .collapsedElement
      // then use this property to replace _collapsedHeaderElement
      // if nothing, then _collapsedHeaderElement is simply GenemoHead
      // flag is the target status

      if (flag && this._collapsedHeaderElement) {
        // there is old collapseHeader, needs to be removed
        this.$.cardHeader.removeChild(this._collapsedHeaderElement)
      } else if (!flag) {
        let contentNode = this.$.cardBodySlot.assignedNodes({ flatten: true })
        if (contentNode) {
          contentNode = contentNode[0]
          this._collapsedHeaderElement = contentNode.collapsedElement
          if (this._collapsedHeaderElement) {
            this.$.cardHeader.appendChild(this._collapsedHeaderElement)
          }
        }
      }
      this._showOriginalHeader = flag && this._collapsedHeaderElement
    }

    _isOpenedChanged (newValue, oldValue) {
      if (newValue) {
        // expand card panel, send signal to parent
        // (so that parent may collapse the siblings of `this`)
        give.fireSignal('card-expanded', null, null, this)
      }
      this.expandIcon = newValue ? 'expand-less' : 'expand-more'
      this._toggleCollapseHeader(newValue)
    }

    toggleCollapse () {
      // hide cardBodySlot and convert GenemoHead to GenemoCollapse (if any)
      this.isOpened = !this.isOpened
    }

    collapse () {
      if (!this.disableFolding) {
        this.isOpened = false
      }
    }

    expand () {
      this.isOpened = true
    }

    populateDOM () {
      // if the content has a .getExpandedHeader member,
      //  it will be used to generate the node to replace the node
      //  given in .GenemoHead
      let contentNodes = this.$.cardBodySlot.assignedNodes({ flatten: true })
      let headerContainer =
        this.shadowRoot.querySelector('#cardHeaderContainer')
      let newHead
      if (!headerContainer) {
        return
      }
      while (headerContainer.firstChild) {
        headerContainer.removeChild(headerContainer.firstChild)
      }
      if (contentNodes && contentNodes[0]) {
        newHead = contentNodes[0].expandedHeaderElement
      }
      if (newHead) {
        headerContainer.appendChild(newHead)
        newHead.classList.add('headerText')
        this.$.hiddenCardHeaderHolder.appendChild(this.$.cardHeaderSlot)
      } else {
        // populate header with #cardhead
        headerContainer.appendChild(this.$.cardHeaderSlot)
        // newHead = this.$.cardHeaderSlot.assignedNodes({ flatten: true })
        // if (newHead) {
        //   newHead.forEach(node => headerContainer.appendChild(node))
        // }
      }
    }

    _setContentReady (flag) {
      if (this._readiness !== flag) {
        if (flag) {
          // check if all assigned nodes have their readiness set to `true`
          if (this.$.cardBodySlot.assignedNodes({ flatten: true })
            .every(node => node.readiness)
          ) {
            this._readiness = true
          }
        } else {
          this._readiness = false
        }
      }
      return this._readiness
    }

    _contentReadyHandler (e) {
      try {
        this._setContentReady(e.detail.flag)
        if (e.preventDefault) {
          e.stopPropagation()
          e.preventDefault()
        }
      } catch (error) {
        give.fireSignal('warning', { errObj: error }, null, this)
      }
    }
  }

  give.GiveCard = GiveCard
  window.customElements.define('give-card', give.GiveCard)

  return give
})(GIVe || {})
  </script>
</dom-module>
