<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../paper-menu/paper-menu.html">
<link rel="import" href="../../iron-signals/iron-signals.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../genemo-visual-components/genemo-styles.html">
<link rel="import" href="../genemo-tab-card-content-behavior/genemo-tab-card-content-behavior.html">
<link href="//fonts.googleapis.com/css?family=Roboto:500,400italic,700italic,700,400" rel="stylesheet" type="text/css">
<dom-module id="search-card-content">
  <template>
    <style include="genemo-shared-styles">
		:host {
			display: block;
			font-family: 'Roboto', Arial, Helvetica, sans-serif;
			font-size: 12px;
			line-height: 1.2em;
			vertical-align: middle;
			padding: 1em;
		}

		a:link {
			color: #FF9800;
			text-decoration: none;
		}
		a:hover {
			text-decoration: underline;
		}
		a:active {
			text-decoration: underline;
		}
		a:visited {
			color: #3F51B5;
		}

		/************************** Polymer and Material Design components below *********************/

		.vertTextBottomContainer > paper-dropdown-menu {
			padding: 0 0.4em 0 0.15em;
		}

		.vertMargined {
			margin: 0.2em 0;
		}

		.sampleButton {
			min-width: 7.5em;
		}

	</style>
    <iron-signals on-iron-signal-toggle="signalToggle"
      on-iron-signal-disable="signalDisabled"
      on-iron-signal-encodecheck="signalEncodeCheck"
      on-iron-signal-updatecontent="signalUpdateContent"
      on-iron-signal-allspeciesready="signalCardReady"> </iron-signals>
    <div class="vertMargined">
      <div class="vertTextBottomContainer clearFix">
        <div><span id = "Reference" class="text">Reference: </span></div>
        <paper-dropdown-menu id="regionDropdown" label="Reference" class="vertMargined text" no-label-float>
          <paper-menu class="dropdown-content" id="speciesToUpload" attr-for-selected="value" selected="{{currentRef}}">
            <template is="dom-repeat" items="[[species]]" filter="encodeFilter">
              <paper-item value="[[item.db]]"><span>[[item.db]]</span> (<span>[[item.commonName]]</span>)</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <paper-button id="fillSample" class="rightFloat vertMargined sampleButton" noink raised on-tap="fillSampleHandler"><span id="Use sample" class="text">Use sample</span></paper-button>
      </div>
      <paper-input id="urlFileInput" class="fullWidth text" label="URL for data file" floatingLabel="true" value="{{InputUrl}}"></paper-input>
      <paper-button class="fullWidth" raised noink id="fileSelectButton" on-tap="fileSelectionHandler">{{uploadButtonText}}</paper-button>
      <input style="display: none;" type="file" id="uploadFileInput" name="uploadFileInput" on-change="inputFileChangedFunc" />
      <paper-tooltip position="bottom" class="fullWidth" offset="-1">
        <span id="Search against" class="text">Please specify the reference genome you would like to search against, then upload your custom peak file below for analysis. Either put your file on a public server and provide the URL, or directly upload the file here. (<a href="/goldenPath/help/customTrack.html#BED" target="_blank">BED, peaks format</a> files are accepted either by uploading or providing URL, <a href="/goldenPath/help/bigWig.html" target="_blank">bigWig files</a> are accepted by URL only.)
      </span></paper-tooltip>
    </div>
    <div>
      <paper-input id="returnEmail" class="fullWidth text" label="(Optional) Your email address" floatingLabel="true" value="{{UserEmail}}"></paper-input>
      <paper-tooltip class="fullWidth" position="top" offset="0">
        <span id = "Computing time" class="text">Some results may take a while to compute. You may provide an email here to get notification once the analysis is completed.</span>
      </paper-tooltip>
    </div>
    <div>
      <paper-input id="urlFileToShow" class="fullWidth text" label="(Optional) Display file URL" floatingLabel="true" value="{{DisplayUrl}}"></paper-input>
      <paper-tooltip class="fullWidth" position="top" offset="-1">
        <span id = "Provide url" class="text">You may also provide a URL for a <a href="/goldenPath/help/wiggle.html">wig</a> / <a href="/goldenPath/help/bigWig.html" target="_blank">bigWig</a> file <strong><em>for display purposes only</em></strong></span>
      </paper-tooltip>
    </div>
    <div>
      <paper-input id="searchRangeInput" class="fullWidth text" label="(Optional) Search range" floatingLabel="true" value="{{SearchRange}}"></paper-input>
      <paper-tooltip class="fullWidth" position="top" offset="0">
        <span id = "Search Range" class="text">You can also specify the range to limit the search results to a certain genome location.</span>
      </paper-tooltip>
    </div>
    <paper-button id="Data selection" class="fullWidth vertMargined trackSelection text" toggles raised noink active="{{trackSelActive}}" on-tap="trackSelectionHandler"> Data selection </paper-button>
    <paper-button class="colored fullWidth vertMargined" raised id="fileSubmit" disabled$="[[isDisabled]]" on-tap="submitForm">
      <iron-icon class="smallInline" icon="search" alt="search"></iron-icon>
      <span id = "Search" class="text">Search</span>
    </paper-button>
    <!-- end upload new file part -->
  </template>
  <script>
    Polymer({

		is: "search-card-content",

		behaviors: [
			_GIVe.GenemoTabCardContentBehavior
		],

		properties: {
			MAX_FILENAME_LEN: {
				type: Number,
				readOnly: true,
				value: 25,
			},

			sampleFile: {
				type: Object,
				value: {
					mm9:  {
						file: "http://www.genemo.org/sample/wgEncodeEM001954.txt",
					},
					hg19: {
						file: "http://www.genemo.org/sample/wgEncodeEH000987_1.bigWig",
						range: "chr10:1-135534747",
					},
				},
				readOnly: true,
			},

			sampleRef: {
				type: String,
				value: "mm9",
				readOnly: true,
			},

			isEncodeOn: {
				type: Boolean,
				value: true,
			},

			InputUrl: {
				type: String,
				value: "",
				observer: "InputUrlChanged"
			},

			currentRef: {
				type: String,
				value: "",
				observer: "currentRefChanged",
			},

			DisplayUrl: {
				type: String,
				value: "",
			},

			UserEmail: {
				type: String,
				value: "",
			},

			SearchRange: {
				type: String,
				value: "",
			},

			SearchRangeArr: {
				type: Array,
				value: function() {
					return [];
				},
			},

			trackSelActive: {
				type: Boolean,
				value: false
			},

			toggleGroup: {
				type: String,
				value: 'trackSelect',
			},

			isDisabled: {
				type: Boolean,
				value: false,
			},

			disableGroup: {
				type: String,
				value: 'query-search',
			},

			uploadButtonText: {
				type: String,
				value: '',
			},

			species: {
				type: Array,
				value: function() {
					return [];
				},
			},
		},

        created: function() {
            this.InputFile = new Blob();
        },

        encodeFilter: function(value) {
			return (value.isEncode || !this.isEncodeOn);
        },

        checkEncodeSpecies: function (flag) {
			if(typeof(flag) == 'boolean') {
				this.isEncodeOn = flag;
			}
            var spcAvailableCount = 0;
            if(this.species.length > 0) {
                this.updateAllSpcActive();
            }
        },

        updateAllSpcActive: function () {
            // numbersOnly means no update of checkboxes to species.isActive
            // otherwise species.isActive will be updated first to reflect choice
            this.species.updateAllSpcActiveNum();
        },

		inputFileChangedFunc: function() {
			var shortFileName = this.$.uploadFileInput.files[0].name;
			if(shortFileName == "") {
				this.$.fileSelectButton.classList.remove("noTextTransformButton");
				this.uploadButtonText = "Upload local file";
			} else {
				shortFileName = shortFileName.replace(/^C:\\fakepath\\/, "");
				if(shortFileName.length > this.MAX_FILENAME_LEN) {
					shortFileName = "..." + shortFileName.substring(shortFileName.length - this.MAX_FILENAME_LEN);
				}
				this.$.fileSelectButton.classList.add("noTextTransformButton");
				this.uploadButtonText = shortFileName;
				this.InputUrl = '';
			}
		},

		InputUrlChanged: function(newValue, oldValue) {
			if(newValue.length > 0) {
				this.$.fileSelectButton.classList.remove("noTextTransformButton");
				this.uploadButtonText = "Upload local file";
			}
		},

		currentRefChanged: function(newValue, oldValue) {
			this.fire("species-changed", {newRef: newValue});
		},

		signalToggle: function(e, detail) {
			if(detail.group == this.toggleGroup) {
				if(detail.flag || (detail.flag == false)) {
					this.trackSelActive = detail.flag;
				} else {
					this.trackSelActive = !this.trackSelActive;
				}
			}
		},

		signalDisabled: function(e, detail) {
			if(detail.group == this.disableGroup) {
				if(detail.flag || (detail.flag == false)) {
					this.isDisabled = detail.flag;
				} else {
					this.isDisabled = !this.isDisabled;
				}
			}
		},

		signalEncodeCheck: function(e, detail) {
			this.checkEncodeSpecies(detail.flag);
		},

		signalUpdateContent: function(e, detail) {
			this.currentRef = detail.sessionObj.db;
			var inputFileName = detail.sessionObj.originalFile;
			var DisplayFileName = detail.sessionObj.hasDisplay?
				(detail.sessionObj.urlToShow.substring(detail.sessionObj.urlToShow.lastIndexOf('/') + 1)) : null;
			var collapseObj = { Ref: this.currentRef, Input: inputFileName };
			if(DisplayFileName) {
				collapseObj.display = DisplayFileName;
			}
			if(detail.sessionObj.searchRange) {
				collapseObj.range = detail.sessionObj.searchRange;
			}
			this.updateCurrentInfo(collapseObj);
		},

		signalCardReady: function(e, detail) {
			this.setReady(true);
		},

		fileSelectionHandler: function() {
			this.$.uploadFileInput.click();
		},

		trackSelectionHandler: function() {
			if(genemoIsOn && !this.currentRef) {
				this.fire("alert", {msg: 'Please select a reference genome before selecting data.'});
				this.trackSelActive = false;
			} else {
				this.trackSelActive = !this.trackSelActive;
				this.fire("toggle-window");
			}
		},

		fillSampleHandler: function() {
			if(!this.currentRef) {
				this.fire("alert", {msg: 'No reference is selected. Please select a reference before using the provided sample.'});
				return;
			}
			if(!this.sampleFile[this.currentRef]) {
				this.fire("alert", {msg: 'No sample file is available for the selected reference.'});
				return;
			}
			this.InputUrl = this.sampleFile[this.currentRef].file;
			if(this.sampleFile[this.currentRef].range) {
				this.SearchRange = this.sampleFile[this.currentRef].range;
			}
		},

		submitForm: function() {
			if(this.$.uploadFileInput.files.length <= 0 && this.InputUrl.length <= 0) {
				this.fire("alert", {msg: 'You need to provide the URL for your input file or select a file to upload!'});
				return false;
			} else if(!this.currentRef) {
				this.fire("alert", {msg: 'You need to select the reference genome for your file!'});
				return false;
			} else if(this.UserEmail.length > 0 && (this.UserEmail.indexOf('@') <= 0
				|| (this.UserEmail.indexOf('@') >= this.UserEmail.lastIndexOf('.') - 1))) {
					this.fire("alert", {msg: 'Please provide a valid email address!'});
					return false;
			}

			this.InputFile = this.$.uploadFileInput.files[0];

			var inputFileName = (this.InputUrl.length > 0? (this.InputUrl.substring(this.InputUrl.lastIndexOf('/') + 1))
				: (this.InputFile.name.substring(this.InputFile.name.lastIndexOf('/') + 1)));
			var DisplayFileName = this.DisplayUrl.length > 0?
				(this.DisplayUrl.substring(this.DisplayUrl.lastIndexOf('/') + 1)) : null;

			var collapseObj = { Ref: this.currentRef, Input: inputFileName };
			if(DisplayFileName) {
				collapseObj.display = DisplayFileName;
			}

			if(this.SearchRange) {
				this.SearchRangeArr = this.SearchRange.split(/[\s:\-]+/g);
				this.SearchRange = this.SearchRangeArr[0] + ':' + this.SearchRangeArr[1] + '-' + this.SearchRangeArr[2];
				collapseObj.range = this.SearchRange;
			}

			this.updateCurrentInfo(collapseObj);

			this.fire("submit-form", {card: this});
		},

        ready: function() {

			this._setIcon('search');
			this._setIconAlt('search');
			this._setHeaderText('Input file');
			this._setTabText('Search');

			this.species = spcArray;

            this.uploadButtonText = "Upload local file";

			this.setDOMReady(true);
			this.setReady(false);

        },

    });
  </script>
</dom-module>
