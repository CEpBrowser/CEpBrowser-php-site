<!--
  List for tracks within one track group
  This DOM element must be placed in a flex container,
  otherwise the iron-list will not work
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../paper-material/paper-material.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-list/iron-list.html">
<link rel="import" href="../../iron-collapse/iron-collapse.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../track-control/track-mini-control.html">
<link rel="import" href="../genemo-styles.html">
<link href="http://fonts.googleapis.com/css?family=Roboto:500,400italic,700italic,700,400" rel="stylesheet" type="text/css">
<dom-module id="chart-track-list">
  <template>
    <style include="genemo-shared-styles" is="custom-style">
      :host {
        padding: 0;
        display: block;
        height: 100%;
        @apply(--layout-flex);
      }
      paper-material {
        margin: 0.5em 0;
        padding: 1em;
        overflow-y: auto;
        height: 100%;
      }
      paper-material > div.header {
        color: #3F51B5;
        margin-bottom: 0.5em;
      }
    </style>
    <paper-material elevation="1">
      <div class="header">[[group.label]]</div>
      <iron-list id="groupList" items="[[group.array]]" as="track"
        selection-enabled multi-selection$="[[!group.singleChoice]]">
        <template>
          <track-mini-control track="[[track]]" group="[[group]]"
            setting-key="[[settingKey]]" selected="[[selected]]">
          </track-mini-control>
        </template>
      </iron-list>
    </paper-material>
  </template>
  <script>
    var GIVe = (function (give) {
      'use strict'

      give.ChartTrackList = Polymer({
        is: 'chart-track-list',

        behaviors: [
          give.GenemoTabCardContentBehavior
        ],

        properties: {
          textSize: {
            type: Number,
            value: 12    // unit is px
          },

          settingKey: {
            type: String,
            value: give.GENEMO_SELECTED_KEY
          },

          group: {
            type: Object
          }
        },

        listeners: {
          'repeat-dom-completed': '_repeatDomCompletedHandler'
        },

        ready: function () {
          this.setDOMReady(true)
          this.setReady(false)
        },

        trackToDOM: function () {
          // this is used when resetting selection
          // DOM means this.$.groupList.selectedItems
          if (this.group && this.group.every) {
            this.$.groupList.clearSelection()
            this.group.every(function (track, index) {
              if (track.getSettings(this.settingKey)) {
                this.$.groupList.selectItem(index)
                return this.$.groupList.multiSelection
              }
              return true
            }, this)
          }
        },

        DOMToTrack: function () {
          // this is used when submitting the results
          if (this.group && this.group.forEach) {
            this.group.forEach(function (track, index) {
              track.setSetting(this.settingKey, false)
            }, this)
            if (this.$.groupList.selectedItems) {
              this.$.groupList.selectedItems.forEach(function (track) {
                track.setSetting(this.settingKey, true)
              }, this)
            }
          }
        },

        resetAllTracks: function () {
          if (this.group && this.group.every) {
            this.group.every(function (track) {
              track.resetSetting(this.settingKey)
            }, this)
            this.trackToDOM()
          }
        },

        applyFilter: function (map, flags) {
          this.group.forEach(function (track, index) {
            if (flags.hasOwnProperty('matched') && map.hasOwnProperty(track.id)) {
              if (flags.matched) {
                this.$.groupList.selectItem(index)
              } else {
                this.$.groupList.deselectItem(index)
              }
            } else if (flags.hasOwnProperty('unmatched') && !map.hasOwnProperty(track.id)) {
              if (flags.unmatched) {
                this.$.groupList.selectItem(index)
              } else {
                this.$.groupList.deselectItem(index)
              }
            }
          })
        }
      })

      return give
    })(GIVe || {})
  </script>
</dom-module>
