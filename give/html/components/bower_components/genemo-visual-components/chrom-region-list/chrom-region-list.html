<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../genemo-tab-card-content-behavior/genemo-tab-card-content-behavior.html">
<link rel="import" href="../chrom-region-selector/chrom-region-selector.html">
<link href="http://fonts.googleapis.com/css?family=Roboto:500,400italic,700italic,700,400" rel="stylesheet" type="text/css">
<dom-module id="chrom-region-list">
  <template>
    <style include="genemo-shared-styles">
    :host {
      padding: 0.5em;
      display: block;
    }
    </style>
    <template is="dom-if" if="[[!_regionListEmpty]]">
      <<paper-card>
        <div class="card-content" id='listContainer'>
          <template is="dom-repeat" id="regionListDom" items="[[regionList]]">
            <chrom-region-selector id="[[item.name]]" region="[[item]]"></chrom-region-selector>
          </template>
        </div>
        <div class="card-actions">
          <a href$="[[bedFileLink]]" download$="[[bedFileName]]" id="bedLink" tabindex="-1">
            <paper-button id="downloadBed">
              <iron-icon icon="file-download"></iron-icon>Download BED File
            </paper-button>
          </a>
        </div>
      </paper-card>
    </template>
    <template is="dom-if" if="[[_regionListEmpty]]">
      <div id='noResultContainer'>
        No result to display. <span>[[_getNoResultInfo()]]</span>
      </div>
    </template>
  </template>
  <script>
  var GIVe = (function (give) {
    'use strict'

    give.ChromRegionList = Polymer({
      is: 'chrom-region-list',

      behaviors: [
        give.GenemoTabCardContentBehavior
      ],

      properties: {

        regionList: {
          type: Array,
          value: function () {
            return []
          }
        },

        textSize: {
          type: Number,
          value: 12    // unit is px
        },

        bedFileLink: {
          type: String,
          value: ''
        },

        bedFileName: {
          type: String,
          value: ''
        }

      },

      created: function () {
      },

      ready: function () {
        this._setIcon('list')
        this._setIconAlt('Results')
        this._setHeaderText('Results')
        this._setTabText('Results')

        this.firstRun = true

        this.setReady(false)
      },

      _regionListEmpty: function () {
        return this.regionList.length <= 0
      },

      _getNoResultInfo: function () {
        return this.firstRun
          ? 'Please use the query panel to get results.'
          : 'Please change your query to get results.'
      },

      setList: function (newList, annotationLine, inputFileName) {
        newList = newList || []
        this.splice('regionList', 0, this.regionList.length)
        newList.forEach(function (item) {
          this.push('regionList', item)
        }, this)
        if (this.regionList.length > 0) {
          this.setBEDFileLink(annotationLine, inputFileName)
          this.firstRun = false
        }
      },

      getListBED: function (includeStrand) {
        var result = ''
        this.regionList.forEach(function (region) {
          result += region.regionToBED(includeStrand) + '\n'
        })
        return result
      },

      setBEDFileLink: function (annotationLine, inputFileName) {
        // bedFileLink is the link for BED files (global object)
        if (this.bedFileLink !== null) {
          window.URL.revokeObjectURL(give.bedFileLink)
        }

        inputFileName = inputFileName || ''
        annotationLine = annotationLine || ''

        if (this.regionList.length > 0) {
          // change the write BED part
          var inputFileNameStem = (inputFileName.lastIndexOf('.') >= 0)
            ? inputFileName.substring(0, inputFileName.lastIndexOf('.'))
            : inputFileName

          var BEDdata = new window.Blob([annotationLine +
            this.getListBED()], {type: 'text/plain'})
          this.bedFileLink = window.URL.createObjectURL(BEDdata)
          this.bedFileName = inputFileNameStem + '_result.bed'
        }
      }

    })

    return give
  })(GIVe || {})
  </script>
</dom-module>
